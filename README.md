# Ops Proxy
## Overview

Ops proxy provides access to internal tools. All access is via SSL and controlled by requiring a cert for the browser.

## Setup

Run the setupca.sh script in the same directory as the setupca.sh script.

Run the setupserver.sh script in the same directory as the setupserver.sh script with CN as the only argument. An example CN is 'ops-proxy.somecompany.com'. An example command line: "./setupserver.sh ops-proxy.somecompany.com"

## Browser cert management
### Creating a browser cert

Create a browser cert by executing the create-client.sh script in the same directory as the create-client.sh script and the client "name" as the only parameter. This will create a directory and then generate certs and p12 file for the brower. On a MAC the p12 file will need to imported into the "Keychain Access" app. Example command lines: './create-client.sh firstname.lastname' and './create-client.sh someone.else'.

### Revoking a browser cert

Revoke a browser cert by executing the revoke-client.sh script in the same directory as the revoke-client.sh script and the client "name" as the only parameter. The client name must be the same one used to create the browser cert. After a browser cert is revoked a new docker container will need to be generated and deployed.

## Dockerfile

The ops-proxy docker container can only be used as the base for another docker container. You must copy the client ca key, CRL as well as the SSL cert and key into your docker container. Icons for each tool the will be proxied must also be copied into your docker continer. An example docker file is below.

```
FROM ops-proxy

COPY ssl-ops/ca/opsca-cert.pem /etc/nginx/clients/opsca-cert.pem
COPY ssl-ops/ca/opsca.crl /etc/nginx/clients/opsca.crl
COPY ssl-ops/ssl/key.pem /etc/nginx/certs/key.pem
COPY ssl-ops/ssl/cert.pem /etc/nginx/certs/cert.pem

COPY nginx/html/images /usr/share/nginx/html/images/
```

If you want to use something other than a self signed cert then copy the files for that cert into /etc/nginx/certs/ in docker container instead of the self signed cert and key the was generated by setupssl.sh

## Environment variables

### URL

The URL variable is used in the links. It needs to be the URL that the browsers will use to navigate to the ops-proxy. For example 'http://ops-proxy@somecompany.com' or 'http://127.0.0.1' for local development and testing.

### SITES

The SITES variables tell the proxy what it's going to proxy. Each site variable is the name, image, proxy port and target host:target port. Each target is a seperate variable ie SITES_1, SITES_2... For example 'SITES_1=Kibana|images/kibana.png|5601|kibana:5601' would show the images/kibana.png with 'Kibana' in the hoverover linking to URL:5601 and proxying to kibana:5601. The command line and docker-compose snippet below would run the ops-proxy on localhost and setup proxying to Kibana and Cerebro

```
docker run -p "80" -p "443" -p "5601" -p "5602" -e 'URL=https://127.0.0.1' -e 'SITES_1=Kibana|images/kibana.png|5601|kibana:5601' -e 'SITES_2=Cerebro|images/cerebro.png|5602|cerebro:9000' example-ops-proxy
```

```
  ops-proxy:
    image: example-ops-proxy
    ports:
      - "80"
      - "443"
      - "5601"
      - "5602"
    environment:
      - URL=https://127.0.0.1
      - SITES_1=Kibana|images/kibana.png|5601|kibana:5601
      - SITES_2=Cerebro|images/cerebro.png|5602|cerebro:9000
```
